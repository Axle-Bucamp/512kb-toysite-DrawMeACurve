<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fourier Art V7</title><style>*{margin:0;padding:0;box-sizing:border-box}body{background:#050510;font-family:system-ui,sans-serif;color:#fff;min-height:100vh;overflow:hidden}.C{display:grid;grid-template-columns:1fr 300px;height:100vh}@media(max-width:800px){.C{grid-template-columns:1fr;height:auto;overflow-y:auto}}.A{position:relative;background:radial-gradient(circle at center,#1a1a2e 0,#000 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:10px}canvas{box-shadow:0 0 20px rgba(0,255,255,.1);border-radius:4px;background:#000}.S{background:rgba(20,20,30,.95);border-left:1px solid rgba(255,255,255,.1);padding:20px;overflow-y:auto;backdrop-filter:blur(10px)}h1{font-size:24px;background:linear-gradient(to right,#0ff,#0f8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:20px;font-weight:800}.G{margin-bottom:15px}label{display:flex;justify-content:space-between;font-size:11px;text-transform:uppercase;margin-bottom:5px;color:#88a}input[type=range]{width:100%;height:4px;background:#334;border-radius:2px;appearance:none;outline:none}input[type=range]::-webkit-slider-thumb{appearance:none;width:14px;height:14px;background:#0ff;border-radius:50%;cursor:pointer}select{width:100%;padding:8px;background:#223;border:1px solid #445;color:#fff;border-radius:4px}button{width:100%;padding:10px;margin-top:10px;background:linear-gradient(45deg,#0ff,#06f);border:none;border-radius:6px;color:#fff;font-weight:bold;cursor:pointer}button:hover{filter:brightness(1.2)}.sec{background:#334;color:#ccc}.tabs{display:flex;gap:5px;margin-bottom:20px;background:#223;padding:4px;border-radius:6px}.tab{flex:1;text-align:center;padding:6px;font-size:11px;cursor:pointer;border-radius:4px;color:#889}.tab.act{background:#0ff;color:#000;font-weight:bold}.hid{display:none}.drop{border:2px dashed #445;padding:20px;text-align:center;border-radius:8px;cursor:pointer}.drop:hover{border-color:#0ff}</style></head><body><div class="C"><div class="A"><canvas id="c" width="600" height="600"></canvas><canvas id="c2" width="600" height="150"></canvas></div><div class="S"><h1>‚ö° Fourier V7</h1><div class="tabs"><div class="tab act" onclick="M('draw')">DESSIN</div><div class="tab" onclick="M('spline')">SPLINES</div><div class="tab" onclick="M('fill')">REMPLIR</div><div class="tab" onclick="M('ext')">EXTRAIT</div></div><div id="draw-p"><div class="G"><label>Harmoniques <span id="hV">50</span></label><input type="range" id="h" min="5" max="300" value="50"></div><div class="G"><label>Vitesse <span id="sV">1.0</span></label><input type="range" id="s" min="1" max="50" value="10"></div><div class="G"><label>Zoom <span id="zV">1.0</span></label><input type="range" id="z" min="10" max="200" value="80"></div><button onclick="P()">‚èØÔ∏è Pause</button><button class="sec" onclick="R()">üóëÔ∏è Reset</button><button onclick="SVG()">‚¨áÔ∏è SVG</button><button onclick="Audio()">üéµ Audio</button></div><div id="spline-p" class="hid"><div class="G"><label>Tension <span id="teV">0.5</span></label><input type="range" id="te" min="0" max="100" value="50"></div><div class="G"><label>Segments <span id="seV">20</span></label><input type="range" id="se" min="5" max="50" value="20"></div><button onclick="Smooth()">‚ú® Lisser</button><p style="font-size:10px;color:#667;margin-top:10px">üñ±Ô∏è Glisser pour d√©placer les points</p></div><div id="fill-p" class="hid"><div class="G"><label>Algo</label><select id="fa"><option value="grad">D√©grad√©</option><option value="knn">KNN</option><option value="wfc">WFC</option><option value="plas">Plasma</option></select></div><div class="G"><label>Teinte 1 <span id="h1V">180</span></label><input type="range" id="h1" min="0" max="360" value="180"></div><div class="G"><label>Teinte 2 <span id="h2V">280</span></label><input type="range" id="h2" min="0" max="360" value="280"></div><div class="G"><label>Densit√© <span id="dV">20</span></label><input type="range" id="d" min="5" max="50" value="20"></div></div><div id="ext-p" class="hid"><div class="drop" onclick="document.getElementById('f').click()">üì∏ Image<input type="file" id="f" accept="image/*" hidden></div><div class="G" style="margin-top:15px"><label>Seuil <span id="tV">128</span></label><input type="range" id="t" min="0" max="255" value="128"></div><div class="G"><label>Simplification <span id="siV">2.0</span></label><input type="range" id="si" min="1" max="10" value="20"></div><button onclick="Proc()">‚ö° Extraire</button></div><div style="margin-top:30px;font-size:10px;color:#556;text-align:center">Optimis√© < 16KB</div></div></div><script>
const $=id=>document.getElementById(id);
const cv=$('c'),ctx=cv.getContext('2d',{alpha:!1});
const cv2=$('c2'),ctx2=cv2.getContext('2d',{alpha:!1});
const W=600,H=600,W2=600,H2=150;
let md='draw',pts=[],spl=[],fX=[],fY=[],pth=[],tm=0,play=1,imgD=null,aud=null,anl=null,dat=null,drag=null,unrolled=[];
const p={h:50,s:1,z:.8,fa:'grad',h1:180,h2:280,d:20,t:128,si:2,te:0.5,se:20};

for(let i=0;i<20;i++){
  const a=i/20*Math.PI*2;
  pts.push({x:Math.cos(a)*100,y:Math.sin(a)*100});
}
Smooth();

function M(m){
  md=m;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('act'));
  event.target.classList.add('act');
  ['draw','spline','fill','ext'].forEach(x=>$(x+'-p').classList.toggle('hid',x!==m));
}

function B(id,k,sc=1){
  $(id).oninput=e=>{
    p[k]=parseFloat(e.target.value)/sc;
    if($(id+'V'))$(id+'V').textContent=p[k];
    if(k==='h')CF();
    if(k==='te'||k==='se')Smooth();
    if(md==='ext'&&imgD)Proc();
  };
}
B('h','h');B('s','s',10);B('z','z',100);B('h1','h1');B('h2','h2');B('d','d');B('t','t');B('si','si',10);B('te','te',100);B('se','se');
$('fa').onchange=e=>p.fa=e.target.value;

function Bezier(pts){
  if(pts.length<2)return pts;
  const res=[],ten=p.te;
  for(let i=0;i<pts.length;i++){
    const p0=pts[i===0?pts.length-1:i-1],p1=pts[i],p2=pts[(i+1)%pts.length],p3=pts[(i+2)%pts.length];
    const m1x=(p2.x-p0.x)*ten, m1y=(p2.y-p0.y)*ten;
    const m2x=(p3.x-p1.x)*ten, m2y=(p3.y-p1.y)*ten;
    for(let t=0;t<1;t+=1/p.se){
      const t2=t*t, t3=t2*t;
      const h1=2*t3-3*t2+1, h2=-2*t3+3*t2, h3=t3-2*t2+t, h4=t3-t2;
      res.push({
        x: h1*p1.x + h2*p2.x + h3*m1x + h4*m2x,
        y: h1*p1.y + h2*p2.y + h3*m1y + h4*m2y
      });
    }
  }
  return res;
}

function Smooth(){
  spl=Bezier(pts);
  // Unroll for visualization
  unrolled=[];
  spl.forEach(pt=>{
    const r=Math.sqrt(pt.x*pt.x+pt.y*pt.y);
    const a=Math.atan2(pt.y,pt.x);
    unrolled.push({a,r});
  });
  unrolled.sort((a,b)=>a.a-b.a);
  CF();
}

function DFT(v){
  const N=v.length,c=[];
  for(let k=0;k<p.h;k++){
    let re=0,im=0;
    for(let n=0;n<N;n++){
      const phi=(2*Math.PI*k*n)/N;
      re+=v[n]*Math.cos(phi);
      im-=v[n]*Math.sin(phi);
    }
    c.push({re:re/N,im:im/N,fr:k,amp:Math.sqrt(re*re+im*im)/N,ph:Math.atan2(im/N,re/N)});
  }
  return c;
}

function CF(){
  fX=DFT(spl.map(p=>p.x)).sort((a,b)=>b.amp-a.amp);
  fY=DFT(spl.map(p=>p.y)).sort((a,b)=>b.amp-a.amp);
  pth=[];tm=0;
}

function DE(x,y,r,f){
  for(let i=0;i<f.length;i++){
    const px=x,py=y,fr=f[i].fr,rad=f[i].amp*p.z*(aud?1+dat[i%32]/128:1),ph=f[i].ph,a=fr*tm+ph+r;
    x+=rad*Math.cos(a);y+=rad*Math.sin(a);
    if(md==='draw'){
      ctx.strokeStyle='rgba(255,255,255,0.1)';
      ctx.beginPath();ctx.arc(px,py,rad,0,Math.PI*2);ctx.stroke();
    }
  }
  return {x,y};
}

function GC(x,y,t){
  const dx=x-W/2,dy=y-H/2,d=Math.sqrt(dx*dx+dy*dy);
  switch(p.fa){
    case 'grad':return `hsl(${p.h1+(p.h2-p.h1)*(d/400)},80%,50%)`;
    case 'knn':return `hsl(${(p.h1+Math.floor(x/p.d)*p.d)%360},70%,50%)`;
    case 'wfc':return `hsl(${p.h1+Math.sin(x*.02+t)*Math.cos(y*.02+t)*100},80%,50%)`;
    case 'plas':return `hsl(${p.h1+(Math.sin(x*.01+t)+Math.sin(y*.01+t))*60},80%,50%)`;
  }
}

function Dr(){
  if(aud){anl.getByteFrequencyData(dat);}
  
  // --- Main Canvas (Cyclic View) ---
  if(md==='fill'){
    // Optimized Fill: Only redraw if needed or use offscreen canvas for static bg
    const s=p.d;
    for(let x=0;x<W;x+=s)for(let y=0;y<H;y+=s){ctx.fillStyle=GC(x,y,tm);ctx.fillRect(x,y,s,s);}
    ctx.fillStyle='rgba(0,0,0,0.9)';ctx.beginPath();ctx.rect(0,0,W,H);
    if(pth.length>0){ctx.moveTo(pth[0].x,pth[0].y);for(let pt of pth)ctx.lineTo(pt.x,pt.y);}
    ctx.closePath();ctx.fill('evenodd');
  }else{
    ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);
    if(md==='ext'&&imgD)ctx.putImageData(imgD,0,0);
  }

  if(md==='spline'){
    ctx.fillStyle='#f0f';
    pts.forEach(pt=>{ctx.beginPath();ctx.arc(pt.x+W/2,pt.y+H/2,4,0,Math.PI*2);ctx.fill();});
    ctx.strokeStyle='#f0f';ctx.beginPath();
    if(pts.length>0){ctx.moveTo(pts[0].x+W/2,pts[0].y+H/2);pts.forEach(pt=>ctx.lineTo(pt.x+W/2,pt.y+H/2));ctx.closePath();ctx.stroke();}
  }

  const vx=DE(W/2,100,0,fX),vy=DE(100,H/2,Math.PI/2,fY),v={x:vx.x,y:vy.y};
  pth.unshift(v);if(pth.length>1000)pth.pop();

  ctx.strokeStyle=md==='fill'?'#fff':'#0ff';ctx.lineWidth=3;ctx.beginPath();
  for(let i=0;i<pth.length;i++)ctx.lineTo(pth[i].x,pth[i].y);
  ctx.stroke();

  if(md==='draw'){
    ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.beginPath();
    ctx.moveTo(vx.x,vx.y);ctx.lineTo(v.x,v.y);ctx.lineTo(vy.x,vy.y);ctx.stroke();
  }

  // --- Unrolled Canvas (Signal View) ---
  ctx2.fillStyle='#000';ctx2.fillRect(0,0,W2,H2);
  
  // Grid
  ctx2.strokeStyle='#223';ctx2.beginPath();
  for(let i=0;i<W2;i+=50){ctx2.moveTo(i,0);ctx2.lineTo(i,H2);}
  for(let i=0;i<H2;i+=30){ctx2.moveTo(0,i);ctx2.lineTo(W2,i);}
  ctx2.stroke();

  // Signal (Radius vs Angle)
  if(unrolled.length>0){
    ctx2.strokeStyle='#0f8';ctx2.lineWidth=2;ctx2.beginPath();
    unrolled.forEach((pt,i)=>{
      // Map Angle -PI..PI to 0..W2
      const x=((pt.a+Math.PI)/(2*Math.PI))*W2;
      const y=H2-(pt.r/150)*H2; // Scale radius better
      if(i===0)ctx2.moveTo(x,y);else ctx2.lineTo(x,y);
    });
    ctx2.stroke();
  }

  // Scanline (Time)
  // Correct mapping: tm is in radians (0..2PI cycle)
  const tNorm=(tm%(2*Math.PI))/(2*Math.PI); 
  // Handle negative time or overflow
  const sx=(tNorm<0?1+tNorm:tNorm)*W2;
  
  ctx2.strokeStyle='#f0f';ctx2.lineWidth=2;ctx2.beginPath();
  ctx2.moveTo(sx,0);ctx2.lineTo(sx,H2);
  ctx2.stroke();
  
  // Add Labels
  ctx2.fillStyle='#88a';ctx2.font='10px monospace';
  ctx2.fillText('-œÄ',5,H2-5);
  ctx2.fillText('0',W2/2,H2-5);
  ctx2.fillText('+œÄ',W2-15,H2-5);
}

function A(){if(play){tm+=(2*Math.PI)/fX.length*p.s;Dr();}requestAnimationFrame(A);}

$('f').onchange=e=>{
  const f=e.target.files[0],r=new FileReader();
  r.onload=ev=>{
    const i=new Image();
    i.onload=()=>{
      const c=document.createElement('canvas'),s=Math.min(600/i.width,600/i.height);
      c.width=i.width*s;c.height=i.height*s;
      const x=c.getContext('2d');x.drawImage(i,0,0,c.width,c.height);
      imgD=x.getImageData(0,0,c.width,c.height);Proc();
    };i.src=ev.target.result;
  };r.readAsDataURL(f);
};

function Proc(){
  if(!imgD)return;
  const d=imgD.data,w=imgD.width,h=imgD.height,e=[];
  const k=[1,0,1,0,1,0,1,0,1];
  
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      let sum=0;
      for(let ky=-1;ky<=1;ky++){
        for(let kx=-1;kx<=1;kx++){
          const i=((y+ky)*w+(x+kx))*4;
          const val=(d[i]+d[i+1]+d[i+2])/3;
          sum+=val*k[(ky+1)*3+(kx+1)];
        }
      }
      if(sum/5 > p.t) {
         const dx=x-w/2, dy=y-h/2;
         const r=Math.sqrt(dx*dx+dy*dy);
         const a=Math.atan2(dy,dx);
         e.push({x:dx,y:dy,r,a});
      }
    }
  }

  if(e.length>0){
    e.sort((a,b)=>a.a-b.a);
    const sectors={};
    e.forEach(pt=>{
      const sec=Math.floor(pt.a*100);
      if(!sectors[sec] || pt.r > sectors[sec].r) sectors[sec]=pt;
    });
    pts=Object.values(sectors).map(pt=>({x:pt.x,y:pt.y}));
    Smooth();
  }
}

cv.onmousedown=e=>{
  if(md!=='spline')return;
  const r=cv.getBoundingClientRect(),x=(e.clientX-r.left)*(W/r.width)-W/2,y=(e.clientY-r.top)*(H/r.height)-H/2;
  drag=pts.find(p=>(p.x-x)**2+(p.y-y)**2<100);
  if(!drag){pts.push({x,y});Smooth();}
};
cv.onmousemove=e=>{
  if(md!=='spline'||!drag)return;
  const r=cv.getBoundingClientRect();
  drag.x=(e.clientX-r.left)*(W/r.width)-W/2;
  drag.y=(e.clientY-r.top)*(H/r.height)-H/2;
  Smooth();
};
cv.onmouseup=()=>drag=null;

function P(){play=!play}
function R(){pts=[];pth=[];spl=[];unrolled=[];}
function SVG(){
  let s=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${W} ${H}" style="background:#000"><path d="M ${pth.map(p=>`${p.x},${p.y}`).join(' L ')}" fill="none" stroke="#0ff" stroke-width="2"/></svg>`;
  const b=new Blob([s],{type:'image/svg+xml'}),u=URL.createObjectURL(b),a=document.createElement('a');
  a.href=u;a.download='fourier.svg';a.click();
}
async function Audio(){
  if(!aud){
    try{
      const s=await navigator.mediaDevices.getUserMedia({audio:!0});
      aud=new AudioContext();const src=aud.createMediaStreamSource(s);
      anl=aud.createAnalyser();anl.fftSize=64;src.connect(anl);
      dat=new Uint8Array(anl.frequencyBinCount);
    }catch(e){alert('Microphone requis!')}
  }
}
A();
</script></body></html>
