<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fourier Art V3 - Fun & Generative</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#050510;
  font-family:'Segoe UI',system-ui,sans-serif;
  overflow-x:hidden;
  color:#fff;
  min-height:100vh
}
.container{
  display:grid;
  grid-template-columns:1fr 300px;
  height:100vh;
  overflow:hidden
}
@media(max-width:800px){.container{grid-template-columns:1fr;height:auto;overflow-y:auto}}

.canvas-area{
  position:relative;
  background:radial-gradient(circle at center,#1a1a2e 0%,#000 100%);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden
}

#canvas{
  box-shadow:0 0 50px rgba(0,255,255,0.1);
  border-radius:4px;
  background:#000
}

.sidebar{
  background:rgba(20,20,30,0.95);
  border-left:1px solid rgba(255,255,255,0.1);
  padding:20px;
  overflow-y:auto;
  backdrop-filter:blur(10px)
}

h1{
  font-size:24px;
  background:linear-gradient(to right,#00f2ff,#00ff88);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:20px;
  font-weight:800;
  letter-spacing:-1px
}

.control-group{margin-bottom:15px}
label{
  display:flex;
  justify-content:space-between;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:1px;
  margin-bottom:5px;
  color:#88a
}
input[type=range]{
  width:100%;
  height:4px;
  background:#334;
  border-radius:2px;
  appearance:none;
  outline:none
}
input[type=range]::-webkit-slider-thumb{
  appearance:none;
  width:14px;
  height:14px;
  background:#00f2ff;
  border-radius:50%;
  cursor:pointer;
  transition:transform .1s
}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.2)}

select{
  width:100%;
  padding:8px;
  background:#223;
  border:1px solid #445;
  color:#fff;
  border-radius:4px;
  font-size:12px
}

button{
  width:100%;
  padding:10px;
  margin-top:10px;
  background:linear-gradient(45deg,#00f2ff,#0066ff);
  border:none;
  border-radius:6px;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
  transition:filter .2s
}
button:hover{filter:brightness(1.2)}
button.secondary{background:#334;color:#ccc}

.tabs{display:flex;gap:5px;margin-bottom:20px;background:#223;padding:4px;border-radius:6px}
.tab{flex:1;text-align:center;padding:6px;font-size:11px;cursor:pointer;border-radius:4px;color:#889}
.tab.active{background:#00f2ff;color:#000;font-weight:bold}

.hidden{display:none}
.file-drop{
  border:2px dashed #445;
  padding:20px;
  text-align:center;
  border-radius:8px;
  cursor:pointer;
  transition:border-color .2s
}
.file-drop:hover{border-color:#00f2ff}
</style>
</head>
<body>

<div class="container">
  <div class="canvas-area">
    <canvas id="canvas" width="800" height="800"></canvas>
  </div>
  
  <div class="sidebar">
    <h1>‚ö° Fourier Fun</h1>
    
    <div class="tabs">
      <div class="tab active" onclick="setMode('draw')">DESSIN</div>
      <div class="tab" onclick="setMode('fill')">REMPLISSAGE</div>
      <div class="tab" onclick="setMode('extract')">EXTRACTION</div>
    </div>

    <!-- DRAW MODE -->
    <div id="draw-panel">
      <div class="control-group">
        <label>Harmoniques <span id="harmVal">50</span></label>
        <input type="range" id="harmonics" min="5" max="300" value="50">
      </div>
      <div class="control-group">
        <label>Vitesse <span id="speedVal">1.0</span></label>
        <input type="range" id="speed" min="1" max="50" value="10">
      </div>
      <div class="control-group">
        <label>Zoom <span id="zoomVal">1.0</span></label>
        <input type="range" id="zoom" min="10" max="200" value="80">
      </div>
      <button onclick="togglePlay()">‚èØÔ∏è Pause / Lecture</button>
      <button class="secondary" onclick="resetPath()">üóëÔ∏è Effacer tout</button>
    </div>

    <!-- FILL MODE -->
    <div id="fill-panel" class="hidden">
      <div class="control-group">
        <label>Algorithme</label>
        <select id="fillAlgo">
          <option value="gradient">D√©grad√© Radial</option>
          <option value="knn">K-Nearest Neighbors</option>
          <option value="wfc">Wave Function</option>
          <option value="plasma">Plasma</option>
        </select>
      </div>
      <div class="control-group">
        <label>Teinte D√©but <span id="hue1Val">180</span></label>
        <input type="range" id="hue1" min="0" max="360" value="180">
      </div>
      <div class="control-group">
        <label>Teinte Fin <span id="hue2Val">280</span></label>
        <input type="range" id="hue2" min="0" max="360" value="280">
      </div>
      <div class="control-group">
        <label>Densit√© <span id="densVal">20</span></label>
        <input type="range" id="density" min="5" max="50" value="20">
      </div>
    </div>

    <!-- EXTRACT MODE -->
    <div id="extract-panel" class="hidden">
      <div class="file-drop" onclick="document.getElementById('file').click()">
        üì∏ Glisser une image ou cliquer
        <input type="file" id="file" accept="image/*" hidden>
      </div>
      <div class="control-group" style="margin-top:15px">
        <label>Seuil <span id="threshVal">128</span></label>
        <input type="range" id="threshold" min="0" max="255" value="128">
      </div>
      <div class="control-group">
        <label>Simplification <span id="simpVal">2.0</span></label>
        <input type="range" id="simplify" min="1" max="10" value="20">
      </div>
      <button onclick="processImage()">‚ö° Extraire Lignes</button>
    </div>
    
    <div style="margin-top:30px;font-size:10px;color:#556;text-align:center">
      Optimis√© < 512KB ‚Ä¢ Fourier Transform ‚Ä¢ Generative Art
    </div>
  </div>
</div>

<script>
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d',{alpha:false});
const W=800,H=800;
canvas.width=W;canvas.height=H;

// State
let mode='draw';
let points=[];
let fourierX=[],fourierY=[];
let path=[];
let time=0;
let isPlaying=true;
let imgData=null;

const params={
  harmonics:50,
  speed:1.0,
  zoom:0.8,
  fillAlgo:'gradient',
  hue1:180,
  hue2:280,
  density:20,
  threshold:128,
  simplify:2.0
};

// Init default shape (Heart)
for(let i=0;i<100;i++){
  const a=i/100*Math.PI*2;
  const r=10*(16*Math.pow(Math.sin(a),3));
  const x=r;
  const y=-10*(13*Math.cos(a)-5*Math.cos(2*a)-2*Math.cos(3*a)-Math.cos(4*a));
  points.push({x,y});
}
computeFourier();

// UI
function setMode(m){
  mode=m;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
  ['draw','fill','extract'].forEach(p=>{
    document.getElementById(p+'-panel').classList.toggle('hidden',p!==m);
  });
}

function bind(id,key,scale=1){
  document.getElementById(id).oninput=e=>{
    params[key]=parseFloat(e.target.value)/scale;
    if(document.getElementById(id+'Val'))
      document.getElementById(id+'Val').textContent=params[key];
    if(key==='harmonics') computeFourier();
    if(mode==='extract'&&imgData) processImage();
  };
}

bind('harmonics','harmonics');
bind('speed','speed',10);
bind('zoom','zoom',100);
bind('hue1','hue1');
bind('hue2','hue2');
bind('density','density');
bind('threshold','threshold');
bind('simplify','simplify',10);

document.getElementById('fillAlgo').onchange=e=>params.fillAlgo=e.target.value;

// Fourier
function dft(vals){
  const N=vals.length;
  const coeffs=[];
  for(let k=0;k<params.harmonics;k++){
    let re=0,im=0;
    for(let n=0;n<N;n++){
      const phi=(2*Math.PI*k*n)/N;
      re+=vals[n]*Math.cos(phi);
      im-=vals[n]*Math.sin(phi);
    }
    re/=N;
    im/=N;
    coeffs.push({re,im,freq:k,amp:Math.sqrt(re*re+im*im),phase:Math.atan2(im,re)});
  }
  return coeffs;
}

function computeFourier(){
  const x=points.map(p=>p.x);
  const y=points.map(p=>p.y);
  fourierX=dft(x);
  fourierY=dft(y);
  fourierX.sort((a,b)=>b.amp-a.amp);
  fourierY.sort((a,b)=>b.amp-a.amp);
  path=[];
  time=0;
}

// Drawing
function drawEpicycles(x,y,rotation,fourier){
  for(let i=0;i<fourier.length;i++){
    const prevX=x,prevY=y;
    const freq=fourier[i].freq;
    const radius=fourier[i].amp*params.zoom;
    const phase=fourier[i].phase;
    const angle=freq*time+phase+rotation;
    x+=radius*Math.cos(angle);
    y+=radius*Math.sin(angle);
    
    if(mode==='draw'){
      ctx.strokeStyle='rgba(255,255,255,0.1)';
      ctx.beginPath();
      ctx.arc(prevX,prevY,radius,0,Math.PI*2);
      ctx.stroke();
    }
  }
  return {x,y};
}

function getColor(x,y,t){
  const dx=x-W/2,dy=y-H/2;
  const d=Math.sqrt(dx*dx+dy*dy);
  const a=Math.atan2(dy,dx);
  
  switch(params.fillAlgo){
    case 'gradient':
      return `hsl(${params.hue1+(params.hue2-params.hue1)*(d/400)},80%,50%)`;
    case 'knn':
      const cell=Math.floor(x/params.density)*params.density;
      return `hsl(${(params.hue1+cell)%360},70%,50%)`;
    case 'wfc':
      const wave=Math.sin(x*0.02+t)*Math.cos(y*0.02+t);
      return `hsl(${params.hue1+wave*100},80%,50%)`;
    case 'plasma':
      const v=Math.sin(x*0.01+t)+Math.sin(y*0.01+t)+Math.sin((x+y)*0.01+t);
      return `hsl(${params.hue1+v*60},80%,50%)`;
  }
}

function draw(){
  // Background
  if(mode==='fill'){
    // Generative background
    const s=params.density;
    for(let x=0;x<W;x+=s){
      for(let y=0;y<H;y+=s){
        ctx.fillStyle=getColor(x,y,time);
        ctx.fillRect(x,y,s,s);
      }
    }
    // Darken center for shape
    ctx.fillStyle='rgba(0,0,0,0.8)';
    ctx.beginPath();
    if(path.length>0){
      ctx.moveTo(path[0].x,path[0].y);
      for(let p of path) ctx.lineTo(p.x,p.y);
    }
    ctx.fill();
  }else{
    ctx.fillStyle='#000';
    ctx.fillRect(0,0,W,H);
  }

  // Fourier
  const vx=drawEpicycles(W/2,100,0,fourierX);
  const vy=drawEpicycles(100,H/2,Math.PI/2,fourierY);
  const v={x:vx.x,y:vy.y};
  
  path.unshift(v);
  if(path.length>1000) path.pop();
  
  // Draw Path
  ctx.strokeStyle=mode==='fill'?'#fff':'#0ff';
  ctx.lineWidth=3;
  ctx.beginPath();
  for(let i=0;i<path.length;i++){
    ctx.lineTo(path[i].x,path[i].y);
  }
  ctx.stroke();
  
  // Connectors
  if(mode==='draw'){
    ctx.strokeStyle='rgba(255,255,255,0.2)';
    ctx.beginPath();
    ctx.moveTo(vx.x,vx.y);
    ctx.lineTo(v.x,v.y);
    ctx.lineTo(vy.x,vy.y);
    ctx.stroke();
  }
}

function animate(){
  if(isPlaying){
    const dt=(2*Math.PI)/fourierX.length;
    time+=dt*params.speed;
    draw();
  }
  requestAnimationFrame(animate);
}

// Image Extraction
document.getElementById('file').onchange=e=>{
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=evt=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement('canvas');
      const scale=Math.min(800/img.width,800/img.height);
      c.width=img.width*scale;
      c.height=img.height*scale;
      const cx=c.getContext('2d');
      cx.drawImage(img,0,0,c.width,c.height);
      imgData=cx.getImageData(0,0,c.width,c.height);
      processImage();
    };
    img.src=evt.target.result;
  };
  reader.readAsDataURL(file);
};

function processImage(){
  if(!imgData)return;
  const d=imgData.data;
  const w=imgData.width;
  const h=imgData.height;
  const edges=[];
  
  // Improved edge detection (Gradient based)
  for(let y=1;y<h-1;y+=2){
    for(let x=1;x<w-1;x+=2){
      const i=(y*w+x)*4;
      const gx = (d[i+4]+d[i+5]+d[i+6]) - (d[i-4]+d[i-3]+d[i-2]);
      const gy = (d[i+w*4]+d[i+w*4+1]+d[i+w*4+2]) - (d[i-w*4]+d[i-w*4+1]+d[i-w*4+2]);
      const mag = Math.sqrt(gx*gx + gy*gy);
      
      if(mag > params.threshold){ 
        edges.push({x:x-w/2,y:y-h/2});
      }
    }
  }
  
  // Sort to single path (Nearest Neighbor)
  if(edges.length>0){
    points=[edges[0]];
    edges.splice(0,1);
    let current=points[0];
    
    while(edges.length>0){
      let nearest=0;
      let minDist=Infinity;
      // Look only at 500 random samples for speed if too many
      const step=Math.max(1,Math.floor(edges.length/500));
      
      for(let i=0;i<edges.length;i+=step){
        const dist=(edges[i].x-current.x)**2+(edges[i].y-current.y)**2;
        if(dist<minDist){
          minDist=dist;
          nearest=i;
        }
      }
      current=edges[nearest];
      points.push(current);
      edges.splice(nearest,1);
    }
    
    // Simplify
    const skip=Math.floor(params.simplify);
    points=points.filter((_,i)=>i%skip===0);
    
    computeFourier();
  }
}

function togglePlay(){isPlaying=!isPlaying}
function resetPath(){points=[];path=[];}

animate();
</script>
</body>
</html>
